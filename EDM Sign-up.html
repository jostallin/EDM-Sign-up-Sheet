<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDM Lab Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .slot-booked { background-color: #fee2e2; border-left: 4px solid #ef4444; }
        .slot-available { background-color: #f0fdf4; border-left: 4px solid #22c55e; cursor: pointer; }
        .slot-available:hover { background-color: #dcfce7; }
        .day-cell { aspect-ratio: 1 / 1; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 0.5rem; transition: all 0.2s; font-weight: 600; font-size: 0.8rem; }
        .day-selected { background-color: #2563eb !important; color: white !important; }
        .day-disabled { color: #cbd5e1; cursor: not-allowed; pointer-events: none; }
        .day-weekend { background-color: #f8fafc; color: #94a3b8; cursor: not-allowed; pointer-events: none; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; align-items: center; justify-content: center; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-white min-h-screen font-sans">

    <!-- Compact Header for Embedding -->
    <nav class="bg-slate-800 text-white p-3 shadow-md">
        <div class="max-w-5xl mx-auto flex justify-between items-center px-2">
            <h1 class="text-lg font-bold flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2-2v12a2 2 0 002 2z" />
                </svg>
                EDM Lab Sign-up
            </h1>
            <div id="status-indicator" class="text-[10px] font-mono bg-slate-700 px-2 py-0.5 rounded text-slate-300 uppercase tracking-tighter">Connecting...</div>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto p-3 flex flex-col lg:flex-row gap-6">
        
        <!-- Left Column: Navigation -->
        <div class="w-full lg:w-72 shrink-0">
            <div class="flex gap-2 mb-4">
                <button onclick="switchMachine('sinker')" id="btn-sinker" class="flex-1 py-2 px-2 rounded-lg border-2 transition-all font-bold text-xs shadow-sm">SINKER</button>
                <button onclick="switchMachine('wire')" id="btn-wire" class="flex-1 py-2 px-2 rounded-lg border-2 transition-all font-bold text-xs shadow-sm">WIRE</button>
            </div>

            <div class="bg-slate-50 p-3 rounded-xl border border-slate-200 shadow-sm">
                <div class="flex justify-between items-center mb-3">
                    <h3 id="calendar-month-year" class="font-bold text-slate-800 text-xs"></h3>
                    <div class="flex gap-1">
                        <button onclick="changeMonth(-1)" class="p-1 hover:bg-slate-200 rounded">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </button>
                        <button onclick="changeMonth(1)" class="p-1 hover:bg-slate-200 rounded">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center text-[9px] font-bold text-slate-400 mb-1">
                    <div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
            </div>
            
            <div class="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-100">
                <p class="text-[10px] text-blue-700 font-medium">Semester: <span class="font-bold">Jan 12 — May 7</span></p>
            </div>
        </div>

        <!-- Right Column: Schedule -->
        <div class="flex-1">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-3 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                    <div>
                        <h2 id="schedule-title" class="font-bold text-slate-700 text-sm">Machine Schedule</h2>
                        <span id="display-date" class="text-[10px] text-slate-500 font-medium italic"></span>
                    </div>
                    <span class="text-[10px] uppercase tracking-wider text-slate-400 font-bold">8 AM - 4 PM</span>
                </div>
                <div id="schedule-container" class="divide-y divide-slate-100 min-h-[300px]"></div>
            </div>
        </div>
    </main>

    <!-- Booking Modal -->
    <div id="booking-modal" class="modal-overlay">
        <div class="bg-white rounded-xl p-6 max-w-sm w-full mx-4 shadow-2xl border border-slate-200">
            <h3 class="text-lg font-bold mb-1 text-slate-800">Reserve Slot</h3>
            <p id="modal-slot-info" class="text-slate-500 text-xs mb-4"></p>
            <div class="space-y-3">
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Full Name</label>
                    <input type="text" id="input-name" class="w-full px-3 py-2 text-sm rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Project Description</label>
                    <input type="text" id="input-project" class="w-full px-3 py-2 text-sm rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Duration</label>
                    <select id="input-duration" class="w-full px-3 py-2 text-sm rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                        <option value="1">1 Hour</option>
                        <option value="2">2 Hours</option>
                        <option value="3">3 Hours</option>
                        <option value="4">4 Hours</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="closeModal()" class="flex-1 py-2 text-sm rounded-lg bg-slate-100 text-slate-600 font-semibold hover:bg-slate-200">Cancel</button>
                <button onclick="confirmBooking()" class="flex-1 py-2 text-sm rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700">Confirm</button>
            </div>
        </div>
    </div>

    <div id="message-box" class="fixed bottom-4 left-1/2 -translate-x-1/2 px-6 py-2 rounded-full bg-slate-900 text-white text-xs shadow-xl opacity-0 transition-opacity pointer-events-none z-50"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getFirestore, doc, setDoc, onSnapshot, collection } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'edm-lab-scheduler';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const SEMESTER_START = new Date('2026-01-12');
        const SEMESTER_END = new Date('2026-05-07');
        
        let viewDate = new Date('2026-01-12'); 
        let selectedDate = '2026-01-12';
        let currentMachine = 'sinker';
        let bookingsData = {};
        let currentUser = null;
        let selectedSlotIndex = null;

        const hours = ["08:00 AM", "09:00 AM", "10:00 AM", "11:00 AM", "12:00 PM", "01:00 PM", "02:00 PM", "03:00 PM"];

        window.switchMachine = (machine) => {
            currentMachine = machine;
            updateUI();
        };

        window.changeMonth = (dir) => {
            viewDate.setMonth(viewDate.getMonth() + dir);
            renderCalendar();
        };

        window.selectDay = (dateStr) => {
            selectedDate = dateStr;
            updateUI();
        };

        window.openModal = (index) => {
            selectedSlotIndex = index;
            const hourLabel = hours[index];
            const d = new Date(selectedDate + 'T12:00:00');
            document.getElementById('modal-slot-info').innerText = `${currentMachine.toUpperCase()} — ${d.toLocaleDateString(undefined, {month:'short', day:'numeric'})} at ${hourLabel}`;
            
            const maxPossible = hours.length - index;
            const select = document.getElementById('input-duration');
            Array.from(select.options).forEach(opt => {
                opt.disabled = parseInt(opt.value) > maxPossible;
            });
            if (parseInt(select.value) > maxPossible) select.value = "1";

            document.getElementById('booking-modal').style.display = 'flex';
            document.getElementById('input-name').focus();
        };

        window.closeModal = () => {
            document.getElementById('booking-modal').style.display = 'none';
        };

        window.confirmBooking = async () => {
            if (!currentUser) return;
            const name = document.getElementById('input-name').value.trim();
            const project = document.getElementById('input-project').value.trim() || 'Lab Work';
            const duration = parseInt(document.getElementById('input-duration').value);
            
            if (!name) return showMessage("Enter your name");

            for (let i = 0; i < duration; i++) {
                const checkIdx = selectedSlotIndex + i;
                const checkTime = hours[checkIdx];
                if (isSlotBooked(checkTime)) {
                    return showMessage(`Conflict at ${checkTime}`);
                }
            }

            const startTime = hours[selectedSlotIndex];
            const bookingId = `${selectedDate}_${currentMachine}_${startTime.replace(/:| /g, '')}`;
            const bookingDoc = doc(db, 'artifacts', appId, 'public', 'data', 'bookings', bookingId);
            
            try {
                await setDoc(bookingDoc, { name, project, machine: currentMachine, date: selectedDate, time: startTime, duration: duration, timestamp: Date.now() });
                closeModal();
                showMessage("Reserved!");
                document.getElementById('input-name').value = '';
                document.getElementById('input-project').value = '';
            } catch (err) { showMessage("Sync Error"); }
        };

        function isSlotBooked(hourStr) {
            const hourIdx = hours.indexOf(hourStr);
            return Object.values(bookingsData).some(b => {
                if (b.date !== selectedDate || b.machine !== currentMachine) return false;
                const bStartIdx = hours.indexOf(b.time);
                const bEndIdx = bStartIdx + (b.duration || 1);
                return hourIdx >= bStartIdx && hourIdx < bEndIdx;
            });
        }

        function getBookingForSlot(hourStr) {
            const hourIdx = hours.indexOf(hourStr);
            return Object.values(bookingsData).find(b => {
                if (b.date !== selectedDate || b.machine !== currentMachine) return false;
                const bStartIdx = hours.indexOf(b.time);
                const bEndIdx = bStartIdx + (b.duration || 1);
                return hourIdx >= bStartIdx && hourIdx < bEndIdx;
            });
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const monthLabel = document.getElementById('calendar-month-year');
            grid.innerHTML = '';
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();
            monthLabel.innerText = viewDate.toLocaleDateString(undefined, { month: 'long', year: 'numeric' });
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) grid.appendChild(document.createElement('div'));
            for (let d = 1; d <= daysInMonth; d++) {
                const dateObj = new Date(year, month, d);
                const dateStr = dateObj.toISOString().split('T')[0];
                const dayDiv = document.createElement('div');
                dayDiv.innerText = d;
                dayDiv.className = 'day-cell';
                const isWeekend = dateObj.getDay() === 0 || dateObj.getDay() === 6;
                const outOfRange = dateObj < SEMESTER_START || dateObj > SEMESTER_END;
                if (outOfRange) dayDiv.classList.add('day-disabled');
                else if (isWeekend) dayDiv.classList.add('day-weekend');
                else {
                    dayDiv.onclick = () => window.selectDay(dateStr);
                    if (dateStr === selectedDate) dayDiv.classList.add('day-selected');
                    else dayDiv.classList.add('hover:bg-blue-50', 'text-slate-700');
                }
                grid.appendChild(dayDiv);
            }
        }

        function renderSchedule() {
            const container = document.getElementById('schedule-container');
            container.innerHTML = '';
            document.getElementById('display-date').innerText = new Date(selectedDate + 'T12:00:00').toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
            hours.forEach((hour, idx) => {
                const booking = getBookingForSlot(hour);
                const slotDiv = document.createElement('div');
                slotDiv.className = `p-4 flex justify-between items-center transition-all ${booking ? 'slot-booked' : 'slot-available'}`;
                if (!booking) slotDiv.onclick = () => window.openModal(idx);
                let statusInfo = `<span class="text-xs font-bold text-green-700">Available</span>`;
                if (booking) {
                    statusInfo = `<div class="text-right leading-tight"><div class="font-bold text-red-800 text-sm">${booking.name}</div><div class="text-[9px] text-red-500 uppercase font-bold">${booking.project} ${booking.duration > 1 ? `(${booking.duration}h)` : ''}</div></div>`;
                }
                slotDiv.innerHTML = `<span class="font-mono font-bold text-slate-700 text-xs">${hour}</span>${statusInfo}`;
                container.appendChild(slotDiv);
            });
        }

        function updateUI() {
            const active = "flex-1 py-2 px-2 rounded-lg border-2 font-bold text-xs border-blue-600 bg-blue-50 text-blue-700 shadow-inner";
            const inactive = "flex-1 py-2 px-2 rounded-lg border-2 font-bold text-xs border-slate-200 bg-white text-slate-400 hover:border-slate-300";
            document.getElementById('btn-sinker').className = currentMachine === 'sinker' ? active : inactive;
            document.getElementById('btn-wire').className = currentMachine === 'wire' ? active : inactive;
            document.getElementById('schedule-title').innerText = `${currentMachine.toUpperCase()} EDM`;
            renderCalendar();
            renderSchedule();
        }

        function showMessage(text) {
            const box = document.getElementById('message-box');
            box.innerText = text;
            box.style.opacity = '1';
            setTimeout(() => { box.style.opacity = '0'; }, 3000);
        }

        async function init() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);
            } catch (e) {}
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (user) {
                    document.getElementById('status-indicator').innerText = 'LIVE';
                    document.getElementById('status-indicator').className = 'text-[10px] font-mono bg-green-100 text-green-800 px-2 py-0.5 rounded';
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'bookings'), (snap) => {
                        bookingsData = {};
                        snap.forEach(doc => { bookingsData[doc.id] = doc.data(); });
                        renderSchedule();
                    });
                }
            });
            updateUI();
        }
        init();
    </script>
</body>
</html>
