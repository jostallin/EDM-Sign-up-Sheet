<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Machine Scheduler</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase Compat Scripts (Zero-Install/Non-Module) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Inline SVG Icons ---
        const Icon = ({ name, className = "w-4 h-4" }) => {
            const icons = {
                chevronLeft: <path d="m15 18-6-6 6-6"/>,
                chevronRight: <path d="m9 18 6-6-6-6"/>,
                plus: <path d="M5 12h14m-7-7v14"/>,
                x: <path d="M18 6 6 18M6 6l12 12"/>,
                clock: (
                    <React.Fragment>
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </React.Fragment>
                ),
                calendar: (
                    <React.Fragment>
                        <rect width="18" height="18" x="3" y="4" rx="2" ry="2"/>
                        <line x1="16" x2="16" y1="2" y2="6"/>
                        <line x1="8" x2="8" y1="2" y2="6"/>
                        <line x1="3" x2="21" y1="10" y2="10"/>
                    </React.Fragment>
                ),
                layers: (
                    <React.Fragment>
                        <polygon points="12 2 2 7 12 12 22 7 12 2"/>
                        <polyline points="2 17 12 22 22 17"/>
                        <polyline points="2 12 12 17 22 12"/>
                    </React.Fragment>
                ),
                alert: (
                    <React.Fragment>
                        <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
                        <line x1="12" x2="12" y1="9" y2="13"/>
                        <line x1="12" x2="12.01" y1="17" y2="17"/>
                    </React.Fragment>
                )
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name]}
                </svg>
            );
        };

        // --- FIREBASE CONFIGURATION ---
        // 1. Go to Firebase Console > Project Settings
        // 2. Scroll to "Your Apps" > Click Web Icon (</>)
        // 3. Paste the config object below:
        const firebaseConfig = {
             apiKey: "AIzaSyDIVQntX5zWfBM8aHTmB2orGquY-GHF5fk",
            authDomain: "machine-sign-up.firebaseapp.com",
            projectId: "machine-sign-up",
            storageBucket: "machine-sign-up.firebasestorage.app",
            messagingSenderId: "1003146473182",
            appId: "1:1003146473182:web:985e45380e0e4d49d9dc4f",
            measurementId: "G-6JL0Z9LEX9"
        };

        const appId = 'machine-scheduler-v3';

        const MACHINES = [
            { id: 'wire-edm', name: 'Wire EDM', category: 'EDM' },
            { id: 'ram-edm', name: 'RAM EDM', category: 'EDM' },
            { id: 'vf1-1', name: 'VF1 CNC #1', category: 'Mill' },
            { id: 'vf1-2', name: 'VF1 CNC #2', category: 'Mill' },
            { id: 'vf2', name: 'VF2 CNC', category: 'Mill' },
            { id: 'sl10-1', name: 'SL10 Lathe #1', category: 'Lathe' },
            { id: 'sl10-2', name: 'SL10 Lathe #2', category: 'Lathe' },
            { id: 'sl10-3', name: 'SL10 Lathe #3', category: 'Lathe' },
            { id: 'ec300', name: 'Horizontal EC300', category: 'Mill' },
            { id: 'edm-drill', name: 'EDM Drill', category: 'EDM' },
        ];

        const START_HOUR = 8;
        const END_HOUR = 18;
        const HOURS = Array.from({ length: END_HOUR - START_HOUR + 1 }, (_, i) => i + START_HOUR);

        const USER_COLORS = [
            { bg: 'bg-indigo-50', border: 'border-indigo-200', text: 'text-indigo-800', accent: 'text-indigo-500', hover: 'hover:ring-indigo-400' },
            { bg: 'bg-emerald-50', border: 'border-emerald-200', text: 'text-emerald-800', accent: 'text-emerald-500', hover: 'hover:ring-emerald-400' },
            { bg: 'bg-amber-50', border: 'border-amber-200', text: 'text-amber-800', accent: 'text-amber-500', hover: 'hover:ring-amber-400' },
            { bg: 'bg-rose-50', border: 'border-rose-200', text: 'text-rose-800', accent: 'text-rose-500', hover: 'hover:ring-rose-400' },
            { bg: 'bg-cyan-50', border: 'border-cyan-200', text: 'text-cyan-800', accent: 'text-cyan-500', hover: 'hover:ring-cyan-400' }
        ];

        const getColorForUser = (name) => {
            if (!name) return USER_COLORS[0];
            let hash = 0;
            for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
            return USER_COLORS[Math.abs(hash) % USER_COLORS.length];
        };

        function App() {
            const [user, setUser] = useState(null);
            const [bookings, setBookings] = useState([]);
            const [loading, setLoading] = useState(true);
            const [viewDate, setViewDate] = useState(new Date());
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [selectedMachine, setSelectedMachine] = useState(MACHINES[0]);
            const [error, setError] = useState(null);
            const [submitting, setSubmitting] = useState(false);
            // Check if any key is still a placeholder or empty
            const configMissing = !firebaseConfig.apiKey || firebaseConfig.apiKey.includes("PASTE_YOUR");
            
            const timelineRef = useRef(null);
            const isDragging = useRef(false);
            const startX = useRef(0);
            const scrollLeft = useRef(0);

            const [formData, setFormData] = useState({
                userName: '', projectName: '',
                startDate: new Date().toISOString().split('T')[0],
                startTime: '08:00', durationHours: '1', durationMinutes: '0'
            });

            const formatLocalDate = (date) => {
                const d = new Date(date);
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            };

            useEffect(() => {
                if (configMissing) {
                    setLoading(false);
                    return;
                }

                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                const auth = firebase.auth();

                const unsubscribe = auth.onAuthStateChanged((user) => {
                    if (user) {
                        setUser(user);
                    } else {
                        auth.signInAnonymously().catch(err => console.error("Auth error:", err));
                    }
                });

                return () => unsubscribe();
            }, [configMissing]);

            useEffect(() => {
                if (!user || configMissing) return;
                const db = firebase.firestore();
                const bookingsRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('bookings');
                
                const unsubscribe = bookingsRef.onSnapshot((snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setBookings(data);
                    setLoading(false);
                }, (err) => {
                    console.error("Firestore error:", err);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [user, configMissing]);

            const handleBooking = async (e) => {
                e.preventDefault();
                if (!user || submitting || configMissing) return;
                setSubmitting(true);
                setError(null);

                const start = new Date(`${formData.startDate}T${formData.startTime}`);
                const durationMs = (parseInt(formData.durationHours || 0) * 3600000) + (parseInt(formData.durationMinutes || 0) * 60000);
                const end = new Date(start.getTime() + durationMs);

                const collision = bookings.find(b => b.machineId === selectedMachine.id && (start.getTime() < b.endTime && end.getTime() > b.startTime));

                if (collision) {
                    setError(`Collision: ${collision.userName} is on ${selectedMachine.name} until ${new Date(collision.endTime).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })}.`);
                    setSubmitting(false);
                    return;
                }

                try {
                    const db = firebase.firestore();
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('bookings').add({
                        machineId: selectedMachine.id, 
                        machineName: selectedMachine.name,
                        userName: formData.userName, 
                        projectName: formData.projectName,
                        startTime: start.getTime(), 
                        endTime: end.getTime(),
                        userId: user.uid, 
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setIsModalOpen(false);
                } catch (err) {
                    console.error("Error saving:", err);
                    setError("Failed to save booking. Please check your Firebase permissions.");
                }
                setSubmitting(false);
            };

            const deleteBooking = (id) => {
                const db = firebase.firestore();
                db.collection('artifacts').doc(appId).collection('public').doc('data').collection('bookings').doc(id).delete();
            };
            
            const changeDay = (offset) => {
                const next = new Date(viewDate);
                next.setDate(next.getDate() + offset);
                setViewDate(next);
            };

            const dayBookings = useMemo(() => {
                const d = new Date(viewDate);
                const s = new Date(d.getFullYear(), d.getMonth(), d.getDate(), START_HOUR, 0, 0).getTime();
                const e = new Date(d.getFullYear(), d.getMonth(), d.getDate(), END_HOUR, 0, 0).getTime();
                return bookings.filter(b => b.startTime < e && b.endTime > s);
            }, [bookings, viewDate]);

            const onDragStart = (e) => { isDragging.current = true; startX.current = e.pageX - timelineRef.current.offsetLeft; scrollLeft.current = timelineRef.current.scrollLeft; };
            const onDragEnd = () => { isDragging.current = false; };
            const onDragMove = (e) => { if (!isDragging.current) return; e.preventDefault(); const x = e.pageX - timelineRef.current.offsetLeft; timelineRef.current.scrollLeft = scrollLeft.current - (x - startX.current) * 1.5; };

            if (configMissing) return (
                <div className="h-screen flex items-center justify-center p-6 text-center bg-slate-100">
                    <div className="max-w-md bg-white p-10 rounded-[2.5rem] shadow-2xl border border-red-100">
                        <Icon name="alert" className="w-16 h-16 text-red-500 mx-auto mb-6" />
                        <h2 className="text-2xl font-black mb-3 text-slate-800">Setup Required</h2>
                        <p className="text-slate-500 text-sm mb-8 leading-relaxed">
                            You need to paste your <strong>firebaseConfig</strong> from the Firebase Console into lines 80-87 of this file to connect the database.
                        </p>
                        <div className="bg-slate-50 p-4 rounded-2xl text-left border border-slate-100">
                            <p className="text-[10px] uppercase font-black text-slate-400 mb-2">Instructions</p>
                            <ol className="text-xs text-slate-600 space-y-2 list-decimal list-inside">
                                <li>Open Firebase Console</li>
                                <li>Project Settings > General</li>
                                <li>Find "Your Apps" > Web App config</li>
                                <li>Copy the config object into this file</li>
                            </ol>
                        </div>
                    </div>
                </div>
            );

            if (loading) return <div className="h-screen flex items-center justify-center font-bold text-slate-500">Connecting to Shop...</div>;

            return (
                <div className="min-h-screen flex flex-col font-sans select-none overflow-hidden">
                    <header className="bg-white border-b p-4 flex justify-between items-center sticky top-0 z-40 shadow-sm">
                        <div className="flex items-center space-x-3">
                            <div className="bg-indigo-600 p-2 rounded-lg shadow-md"><Icon name="layers" className="text-white w-5 h-5"/></div>
                            <h1 className="text-lg font-bold text-slate-800">Shop Scheduler</h1>
                        </div>
                        <div className="flex items-center space-x-2">
                            <button onClick={() => changeDay(-1)} className="p-2 border rounded-lg hover:bg-slate-50 transition-colors"><Icon name="chevronLeft" size={16}/></button>
                            <input type="date" value={formatLocalDate(viewDate)} onChange={e => setViewDate(new Date(e.target.value + 'T00:00:00'))} className="border p-2 rounded-lg font-bold text-sm bg-white cursor-pointer" />
                            <button onClick={() => changeDay(1)} className="p-2 border rounded-lg hover:bg-slate-50 transition-colors"><Icon name="chevronRight" size={16}/></button>
                            <button onClick={() => { setError(null); setIsModalOpen(true); }} className="bg-indigo-600 text-white px-4 py-2 rounded-xl text-sm font-bold ml-2 shadow-lg shadow-indigo-200 hover:bg-indigo-700 active:scale-95 transition-all">+ Schedule</button>
                        </div>
                    </header>

                    <main ref={timelineRef} onMouseDown={onDragStart} onMouseUp={onDragEnd} onMouseLeave={onDragEnd} onMouseMove={onDragMove} className="flex-1 overflow-auto p-6 bg-slate-50 cursor-grab active:cursor-grabbing">
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 inline-block min-w-full overflow-hidden">
                            <div className="flex border-b bg-slate-50/50">
                                <div className="w-48 p-4 border-r font-bold text-[10px] text-slate-400 uppercase tracking-widest">MACHINE</div>
                                <div className="flex flex-1">
                                    {HOURS.map(h => <div key={h} className="w-32 text-center py-4 border-r text-[10px] font-bold text-slate-400">{h > 12 ? h-12+' PM' : h === 12 ? '12 PM' : h+' AM'}</div>)}
                                </div>
                            </div>
                            {MACHINES.map(m => (
                                <div key={m.id} className="flex border-b last:border-0 hover:bg-slate-50/30">
                                    <div className="w-48 p-4 border-r bg-white sticky left-0 z-10 shadow-[2px_0_5px_rgba(0,0,0,0.02)]">
                                        <div className="font-bold text-sm text-slate-700">{m.name}</div>
                                        <div className="text-[9px] text-indigo-500 font-bold uppercase tracking-tighter">{m.category}</div>
                                    </div>
                                    <div className="flex flex-1 relative h-16">
                                        {HOURS.map(h => <div key={h} className="w-32 border-r border-slate-100 h-full" />)}
                                        {dayBookings.filter(b => b.machineId === m.id).map(b => {
                                            const startOfView = new Date(viewDate).setHours(START_HOUR,0,0,0);
                                            const left = (Math.max(startOfView, b.startTime) - startOfView) / 3600000 * 128;
                                            const width = (Math.min(startOfView + 36000000, b.endTime) - Math.max(startOfView, b.startTime)) / 3600000 * 128;
                                            const color = getColorForUser(b.userName);
                                            return (
                                                <div key={b.id} onMouseDown={e => e.stopPropagation()} style={{left: left+'px', width: width+'px'}} className={`absolute top-2 bottom-2 ${color.bg} border ${color.border} rounded-lg p-2 overflow-hidden shadow-sm group hover:ring-2 hover:ring-indigo-400 transition-all z-20`}>
                                                    <div className="flex justify-between items-center">
                                                        <span className={`text-[10px] font-bold ${color.text} truncate uppercase leading-none`}>{b.userName}</span>
                                                        <button onClick={() => deleteBooking(b.id)} className="opacity-0 group-hover:opacity-100 text-red-500 hover:bg-red-50 p-0.5 rounded transition-all"><Icon name="x" className="w-3 h-3"/></button>
                                                    </div>
                                                    <div className={`text-[9px] ${color.accent} font-bold truncate mt-0.5 opacity-80`}>{b.projectName}</div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </main>

                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm overflow-y-auto">
                            <form onSubmit={handleBooking} className="bg-white rounded-3xl p-8 w-full max-w-md space-y-5 shadow-2xl animate-in fade-in zoom-in duration-200 my-auto">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-2xl font-bold text-slate-800 tracking-tight">Schedule Entry</h2>
                                    <button type="button" onClick={() => setIsModalOpen(false)} className="text-slate-400 hover:bg-slate-50 p-2 rounded-full"><Icon name="x" className="w-6 h-6"/></button>
                                </div>
                                {error && <div className="flex items-center space-x-2 p-4 bg-red-50 text-red-700 rounded-2xl text-xs font-bold border border-red-100"><Icon name="alert" className="w-5 h-5 flex-shrink-0" /><span>{error}</span></div>}
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1 mb-1 block">Machine</label>
                                        <select value={selectedMachine.id} onChange={e => setSelectedMachine(MACHINES.find(m => m.id === e.target.value))} className="w-full border-slate-200 border p-3.5 rounded-2xl font-bold bg-slate-50 focus:ring-4 focus:ring-indigo-500/10 outline-none transition-all">
                                            {MACHINES.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
                                        </select>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1 mb-1 block">Operator</label>
                                            <input required placeholder="Your Name" className="w-full border-slate-200 border p-3.5 rounded-2xl bg-slate-50 focus:ring-4 focus:ring-indigo-500/10 outline-none transition-all font-bold" onChange={e => setFormData({...formData, userName: e.target.value})}/>
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1 mb-1 block">Project / Job #</label>
                                            <input required placeholder="WO-1234" className="w-full border-slate-200 border p-3.5 rounded-2xl bg-slate-50 focus:ring-4 focus:ring-indigo-500/10 outline-none transition-all font-bold" onChange={e => setFormData({...formData, projectName: e.target.value})}/>
                                        </div>
                                    </div>
                                    <div className="p-5 bg-slate-50 rounded-3xl border border-slate-100 space-y-4 shadow-inner">
                                        <div className="text-[10px] font-bold text-indigo-500 uppercase tracking-widest flex items-center gap-2"><Icon name="clock" className="w-4 h-4" /> Start Time</div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <input type="date" value={formData.startDate} className="border-slate-200 border p-3 rounded-xl font-bold text-sm bg-white" onChange={e => setFormData({...formData, startDate: e.target.value})}/>
                                            <input type="time" value={formData.startTime} className="border-slate-200 border p-3 rounded-xl font-bold text-sm bg-white" onChange={e => setFormData({...formData, startTime: e.target.value})}/>
                                        </div>
                                    </div>
                                    <div className="p-5 bg-slate-50 rounded-3xl border border-slate-100 space-y-4 shadow-inner">
                                        <div className="text-[10px] font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2"><Icon name="calendar" className="w-4 h-4" /> Duration</div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <input type="number" placeholder="Hours" min="0" className="border-slate-200 border p-3 rounded-xl font-bold text-sm bg-white" onChange={e => setFormData({...formData, durationHours: e.target.value})}/>
                                            <input type="number" placeholder="Minutes" min="0" max="59" className="border-slate-200 border p-3 rounded-xl font-bold text-sm bg-white" onChange={e => setFormData({...formData, durationMinutes: e.target.value})}/>
                                        </div>
                                    </div>
                                </div>
                                <div className="flex space-x-3 pt-4">
                                    <button type="button" onClick={() => setIsModalOpen(false)} className="flex-1 p-4 bg-slate-100 hover:bg-slate-200 rounded-2xl font-bold text-slate-600 transition-all">Cancel</button>
                                    <button type="submit" disabled={submitting} className={`flex-1 p-4 rounded-2xl font-bold text-white shadow-lg transition-all ${submitting ? 'bg-slate-400 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700 shadow-indigo-200 active:scale-95'}`}>
                                        {submitting ? 'Saving...' : 'Save Schedule'}
                                    </button>
                                </div>
                            </form>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
