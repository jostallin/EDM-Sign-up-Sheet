<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Machine Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
        const { useState, useEffect, useMemo, useRef } = React;

        const Icon = ({ name, className = "w-4 h-4" }) => {
            const icons = {
                chevronLeft: <path d="m15 18-6-6 6-6"/>,
                chevronRight: <path d="m9 18 6-6-6-6"/>,
                plus: <path d="M5 12h14m-7-7v14"/>,
                x: <path d="M18 6 6 18M6 6l12 12"/>,
                clock: (<React.Fragment><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></React.Fragment>),
                calendar: (<React.Fragment><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></React.Fragment>),
                layers: (<React.Fragment><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></React.Fragment>),
                alert: (<React.Fragment><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></React.Fragment>),
                user: (<React.Fragment><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></React.Fragment>)
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name]}
                </svg>
            );
        };

        const firebaseConfig = {
            apiKey: "AIzaSyDIVQntX5zWfBM8aHTmB2orGquY-GHF5fk",
            authDomain: "machine-sign-up.firebaseapp.com",
            projectId: "machine-sign-up",
            storageBucket: "machine-sign-up.firebasestorage.app",
            messagingSenderId: "1003146473182",
            appId: "1:1003146473182:web:985e45380e0e4d49d9dc4f",
            measurementId: "G-6JL0Z9LEX9"
        };

        const appId = 'machine-scheduler-v3';
        const MACHINES = [
            { id: 'wire-edm', name: 'Wire EDM', category: 'EDM' },
            { id: 'ram-edm', name: 'RAM EDM', category: 'EDM' },
            { id: 'vf1-1', name: 'VF1 CNC #1', category: 'Mill' },
            { id: 'vf1-2', name: 'VF1 CNC #2', category: 'Mill' },
            { id: 'vf2', name: 'VF2 CNC', category: 'Mill' },
            { id: 'sl10-1', name: 'SL10 Lathe #1', category: 'Lathe' },
            { id: 'sl10-2', name: 'SL10 Lathe #2', category: 'Lathe' },
            { id: 'sl10-3', name: 'SL10 Lathe #3', category: 'Lathe' },
            { id: 'ec300', name: 'Horizontal EC300', category: 'Mill' },
            { id: 'edm-drill', name: 'EDM Drill', category: 'EDM' },
        ];

        const START_HOUR = 8;
        const END_HOUR = 18;
        const HOURS = Array.from({ length: END_HOUR - START_HOUR + 1 }, (_, i) => i + START_HOUR);

        const getColorForUser = (name) => {
            const colors = [
                { bg: 'bg-indigo-50', border: 'border-indigo-200', text: 'text-indigo-800', accent: 'text-indigo-500' },
                { bg: 'bg-emerald-50', border: 'border-emerald-200', text: 'text-emerald-800', accent: 'text-emerald-500' },
                { bg: 'bg-amber-50', border: 'border-amber-200', text: 'text-amber-800', accent: 'text-amber-500' },
                { bg: 'bg-rose-50', border: 'border-rose-200', text: 'text-rose-800', accent: 'text-rose-500' },
                { bg: 'bg-cyan-50', border: 'border-cyan-200', text: 'text-cyan-800', accent: 'text-cyan-500' }
            ];
            if (!name) return colors[0];
            let hash = 0;
            for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
            return colors[Math.abs(hash) % colors.length];
        };

        function App() {
            const [user, setUser] = useState(null);
            const [bookings, setBookings] = useState([]);
            const [loading, setLoading] = useState(true);
            const [viewDate, setViewDate] = useState(new Date());
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isLoginOpen, setIsLoginOpen] = useState(false);
            const [selectedMachine, setSelectedMachine] = useState(MACHINES[0]);
            const [error, setError] = useState(null);
            const [submitting, setSubmitting] = useState(false);
            const [loginData, setLoginData] = useState({ email: '', password: '' });
            
            const timelineRef = useRef(null);
            const isDragging = useRef(false);
            const startX = useRef(0);
            const scrollLeft = useRef(0);

            const isAdmin = user && !user.isAnonymous;

            const [formData, setFormData] = useState({
                userName: '', projectName: '',
                startDate: new Date().toISOString().split('T')[0],
                startTime: '08:00', durationHours: '1', durationMinutes: '0'
            });

            useEffect(() => {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                const auth = firebase.auth();
                return auth.onAuthStateChanged((u) => {
                    if (u) { setUser(u); } 
                    else { auth.signInAnonymously(); }
                });
            }, []);

            useEffect(() => {
                if (!user) return;
                const db = firebase.firestore();
                const bookingsRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('bookings');
                return bookingsRef.onSnapshot((snapshot) => {
                    setBookings(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setLoading(false);
                }, () => setLoading(false));
            }, [user]);

            const handleAdminLogin = async (e) => {
                e.preventDefault();
                setError(null);
                try {
                    await firebase.auth().signInWithEmailAndPassword(loginData.email, loginData.password);
                    setIsLoginOpen(false);
                } catch (err) {
                    setError("Invalid admin credentials.");
                }
            };

            const handleBooking = async (e) => {
                e.preventDefault();
                if (!user || submitting) return;
                setSubmitting(true);
                setError(null);
                const start = new Date(`${formData.startDate}T${formData.startTime}`);
                const end = new Date(start.getTime() + (parseInt(formData.durationHours || 0) * 3600000) + (parseInt(formData.durationMinutes || 0) * 60000));
                
                if (bookings.find(b => b.machineId === selectedMachine.id && (start.getTime() < b.endTime && end.getTime() > b.startTime))) {
                    setError("Machine is already booked for this time.");
                    setSubmitting(false);
                    return;
                }

                try {
                    await firebase.firestore().collection('artifacts').doc(appId).collection('public').doc('data').collection('bookings').add({
                        machineId: selectedMachine.id, machineName: selectedMachine.name,
                        userName: formData.userName, projectName: formData.projectName,
                        startTime: start.getTime(), endTime: end.getTime(),
                        userId: user.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setIsModalOpen(false);
                } catch (err) { setError("Save failed. Check Firebase rules."); }
                setSubmitting(false);
            };

            const deleteBooking = (id) => firebase.firestore().collection('artifacts').doc(appId).collection('public').doc('data').collection('bookings').doc(id).delete();
            const changeDay = (off) => { const n = new Date(viewDate); n.setDate(n.getDate() + off); setViewDate(n); };

            const dayBookings = useMemo(() => {
                const s = new Date(viewDate).setHours(START_HOUR,0,0,0);
                const e = new Date(viewDate).setHours(END_HOUR,0,0,0);
                return bookings.filter(b => b.startTime < e && b.endTime > s);
            }, [bookings, viewDate]);

            if (loading) return <div className="h-screen flex items-center justify-center font-bold text-slate-400">Loading...</div>;

            return (
                <div className="min-h-screen flex flex-col font-sans select-none overflow-hidden">
                    <header className="bg-white border-b p-4 flex justify-between items-center sticky top-0 z-40 shadow-sm">
                        <div className="flex items-center space-x-3">
                            <div className="bg-indigo-600 p-2 rounded-lg shadow-md"><Icon name="layers" className="text-white w-5 h-5"/></div>
                            <div>
                                <h1 className="text-lg font-bold text-slate-800">Shop Scheduler</h1>
                                {isAdmin && <span className="text-[9px] font-black text-emerald-500 uppercase tracking-widest">Admin Mode</span>}
                            </div>
                        </div>
                        <div className="flex items-center space-x-2">
                            <button onClick={() => changeDay(-1)} className="p-2 border rounded-lg hover:bg-slate-50"><Icon name="chevronLeft" size={16}/></button>
                            <input type="date" value={viewDate.toISOString().split('T')[0]} onChange={e => setViewDate(new Date(e.target.value + 'T00:00:00'))} className="border p-2 rounded-lg font-bold text-sm bg-white" />
                            <button onClick={() => changeDay(1)} className="p-2 border rounded-lg hover:bg-slate-50"><Icon name="chevronRight" size={16}/></button>
                            <button onClick={() => { setError(null); setIsModalOpen(true); }} className="bg-indigo-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all">+ Schedule</button>
                            <button onClick={() => setIsLoginOpen(true)} className={`p-2 transition-colors ${isAdmin ? 'text-indigo-600' : 'text-slate-400 hover:text-indigo-600'}`}><Icon name="user" className="w-5 h-5"/></button>
                        </div>
                    </header>

                    <main ref={timelineRef} onMouseDown={e => { isDragging.current = true; startX.current = e.pageX - timelineRef.current.offsetLeft; scrollLeft.current = timelineRef.current.scrollLeft; }} onMouseUp={() => isDragging.current = false} onMouseLeave={() => isDragging.current = false} onMouseMove={e => { if (!isDragging.current) return; e.preventDefault(); timelineRef.current.scrollLeft = scrollLeft.current - (e.pageX - timelineRef.current.offsetLeft - startX.current) * 1.5; }} className="flex-1 overflow-auto p-6 bg-slate-50 cursor-grab active:cursor-grabbing">
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 inline-block min-w-full overflow-hidden">
                            <div className="flex border-b bg-slate-50/50">
                                <div className="w-48 p-4 border-r font-bold text-[10px] text-slate-400 uppercase tracking-widest">MACHINE</div>
                                <div className="flex flex-1">
                                    {HOURS.map(h => <div key={h} className="w-32 text-center py-4 border-r text-[10px] font-bold text-slate-400">{h > 12 ? h-12+' PM' : h === 12 ? '12 PM' : h+' AM'}</div>)}
                                </div>
                            </div>
                            {MACHINES.map(m => (
                                <div key={m.id} className="flex border-b last:border-0 hover:bg-slate-50/30">
                                    <div className="w-48 p-4 border-r bg-white sticky left-0 z-10">
                                        <div className="font-bold text-sm text-slate-700">{m.name}</div>
                                        <div className="text-[9px] text-indigo-500 font-bold uppercase">{m.category}</div>
                                    </div>
                                    <div className="flex flex-1 relative h-16">
                                        {HOURS.map(h => <div key={h} className="w-32 border-r border-slate-100 h-full" />)}
                                        {dayBookings.filter(b => b.machineId === m.id).map(b => {
                                            const sView = new Date(viewDate).setHours(START_HOUR,0,0,0);
                                            const left = (Math.max(sView, b.startTime) - sView) / 3600000 * 128;
                                            const width = (Math.min(sView + 36000000, b.endTime) - Math.max(sView, b.startTime)) / 3600000 * 128;
                                            const color = getColorForUser(b.userName);
                                            const isOwner = user && b.userId === user.uid;
                                            
                                            return (
                                                <div key={b.id} onMouseDown={e => e.stopPropagation()} style={{left: left+'px', width: width+'px'}} className={`absolute top-2 bottom-2 ${color.bg} border ${color.border} rounded-lg p-2 overflow-hidden shadow-sm group hover:ring-2 hover:ring-indigo-400 transition-all z-20`}>
                                                    <div className="flex justify-between items-center">
                                                        <span className={`text-[10px] font-bold ${color.text} truncate uppercase leading-none`}>{b.userName}</span>
                                                        {(isOwner || isAdmin) && (
                                                            <button onClick={() => deleteBooking(b.id)} className="opacity-0 group-hover:opacity-100 text-red-500 hover:bg-red-50 p-0.5 rounded"><Icon name="x" className="w-3 h-3"/></button>
                                                        )}
                                                    </div>
                                                    <div className={`text-[9px] ${color.accent} font-bold truncate mt-0.5 opacity-80`}>{b.projectName}</div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </main>

                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm overflow-y-auto">
                            <form onSubmit={handleBooking} className="bg-white rounded-3xl p-8 w-full max-w-md space-y-5 shadow-2xl animate-in fade-in zoom-in duration-200 my-auto">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-2xl font-bold text-slate-800">Schedule Entry</h2>
                                    <button type="button" onClick={() => setIsModalOpen(false)} className="text-slate-400 hover:bg-slate-50 p-2 rounded-full"><Icon name="x" className="w-6 h-6"/></button>
                                </div>
                                {error && <div className="p-3 bg-red-50 text-red-700 rounded-xl text-xs font-bold border border-red-100">{error}</div>}
                                <div className="space-y-4">
                                    <select value={selectedMachine.id} onChange={e => setSelectedMachine(MACHINES.find(m => m.id === e.target.value))} className="w-full border-slate-200 border p-3.5 rounded-2xl font-bold bg-slate-50 outline-none">
                                        {MACHINES.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
                                    </select>
                                    <div className="grid grid-cols-2 gap-4">
                                        <input required placeholder="Name" className="w-full border-slate-200 border p-3.5 rounded-2xl bg-slate-50 font-bold" onChange={e => setFormData({...formData, userName: e.target.value})}/>
                                        <input required placeholder="Project" className="w-full border-slate-200 border p-3.5 rounded-2xl bg-slate-50 font-bold" onChange={e => setFormData({...formData, projectName: e.target.value})}/>
                                    </div>
                                    <div className="p-4 bg-slate-50 rounded-2xl border border-slate-100 space-y-3">
                                        <div className="text-[10px] font-bold text-indigo-500 uppercase tracking-widest flex items-center gap-2"><Icon name="clock" className="w-4 h-4" /> Time</div>
                                        <div className="grid grid-cols-2 gap-2">
                                            <input type="date" value={formData.startDate} className="border p-2 rounded-xl text-xs font-bold" onChange={e => setFormData({...formData, startDate: e.target.value})}/>
                                            <input type="time" value={formData.startTime} className="border p-2 rounded-xl text-xs font-bold" onChange={e => setFormData({...formData, startTime: e.target.value})}/>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <input type="number" placeholder="Hours" min="0" className="border p-3 rounded-xl font-bold text-sm" onChange={e => setFormData({...formData, durationHours: e.target.value})}/>
                                        <input type="number" placeholder="Mins" min="0" max="59" className="border p-3 rounded-xl font-bold text-sm" onChange={e => setFormData({...formData, durationMinutes: e.target.value})}/>
                                    </div>
                                </div>
                                <button type="submit" disabled={submitting} className="w-full p-4 bg-indigo-600 text-white rounded-2xl font-bold shadow-lg hover:bg-indigo-700 active:scale-95 transition-all">Save Schedule</button>
                            </form>
                        </div>
                    )}

                    {isLoginOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
                            <form onSubmit={handleAdminLogin} className="bg-white rounded-3xl p-8 w-full max-w-sm space-y-5 shadow-2xl">
                                <h2 className="text-xl font-bold text-slate-800">Admin Login</h2>
                                {error && <div className="text-red-500 text-xs font-bold">{error}</div>}
                                <input required type="email" placeholder="Email" className="w-full border p-3 rounded-xl" onChange={e => setLoginData({...loginData, email: e.target.value})}/>
                                <input required type="password" placeholder="Password" className="w-full border p-3 rounded-xl" onChange={e => setLoginData({...loginData, password: e.target.value})}/>
                                <div className="flex space-x-2">
                                    <button type="button" onClick={() => setIsLoginOpen(false)} className="flex-1 p-3 bg-slate-100 rounded-xl font-bold">Cancel</button>
                                    <button type="submit" className="flex-1 p-3 bg-slate-800 text-white rounded-xl font-bold">Login</button>
                                </div>
                            </form>
                        </div>
                    )}
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
